name: Deploy Full Stack Application

# Project Structure:
# - FreeWaterTips.API.Azure.Functions/ - Azure Functions backend (.NET)
# - FreeWaterTips.ReactNative/ - React Native with Expo (Web, Android & iOS)

on:
  push:
    branches:
      - master
      - 'feature/*'
  pull_request:
    branches:
      - master

permissions:
  contents: write
  id-token: write

concurrency:
  group: "deploy-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
    
    steps:
      - name: Detect environment
        id: detect
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "environment=Production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/heads/feature/.* ]]; then
            echo "environment=Production" >> $GITHUB_OUTPUT
          else
            echo "environment=Production" >> $GITHUB_OUTPUT
          fi
          
          echo "Detected environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"
          echo "Branch: ${{ github.ref }}"

  build-azure-functions:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Cache .NET packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: azure-functions-${{ runner.os }}-nuget-${{ hashFiles('**/FreeWaterTips.API.Azure.Functions.csproj', '**/FreeWaterTips.DB.Cosmos.csproj', '**/FreeWaterTips.Utils.csproj') }}
          restore-keys: |
            azure-functions-${{ runner.os }}-nuget-
          
      - name: Restore dependencies
        run: dotnet restore FreeWaterTips.API.Azure.Functions/FreeWaterTips.API.Azure.Functions.csproj
        
      - name: Build Azure Functions
        run: dotnet build FreeWaterTips.API.Azure.Functions/FreeWaterTips.API.Azure.Functions.csproj --configuration Release --no-restore
        
      - name: Publish Azure Functions
        run: dotnet publish FreeWaterTips.API.Azure.Functions/FreeWaterTips.API.Azure.Functions.csproj --configuration Release --output ./publish/azure-functions --no-build
        
      - name: Upload Azure Functions artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./publish/azure-functions
          retention-days: 30

  build-web:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      EXPO_PUBLIC_AZURE_FUNCTIONS_ENDPOINT: ${{ secrets.AZURE_FUNCTIONS_ENDPOINT }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: FreeWaterTips.ReactNative/package-lock.json
          
      - name: Install dependencies
        working-directory: FreeWaterTips.ReactNative
        run: npm ci
          
      - name: Build web application for production
        if: needs.detect-environment.outputs.environment == 'Production'
        working-directory: FreeWaterTips.ReactNative
        run: npx expo export --platform web --output-dir ./dist
        
      - name: Build web application for testing
        if: needs.detect-environment.outputs.environment == 'Testing'
        working-directory: FreeWaterTips.ReactNative
        run: npx expo export --platform web --output-dir ./dist
        
      - name: Configure environment settings
        working-directory: FreeWaterTips.ReactNative/dist
        run: |
          if [[ "${{ needs.detect-environment.outputs.environment }}" == "Production" ]]; then
            echo "freewater.tips" > CNAME
          fi
          
      - name: Upload production artifact
        if: needs.detect-environment.outputs.environment == 'Production'
        uses: actions/upload-artifact@v4
        with:
          name: web-production-artifact
          path: FreeWaterTips.ReactNative/dist
          retention-days: 1
          
      - name: Upload testing artifact
        if: needs.detect-environment.outputs.environment == 'Testing'
        uses: actions/upload-artifact@v4
        with:
          name: web-testing-artifact
          path: FreeWaterTips.ReactNative/dist
          retention-days: 1

  build-android: 
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      EXPO_PUBLIC_AZURE_FUNCTIONS_ENDPOINT: ${{ secrets.AZURE_FUNCTIONS_ENDPOINT }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: FreeWaterTips.ReactNative/package-lock.json
          
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          
      - name: Install dependencies
        working-directory: FreeWaterTips.ReactNative
        run: npm ci
        
      - name: Build Android APK
        working-directory: FreeWaterTips.ReactNative
        run: eas build --platform android --profile production --non-interactive --no-wait
        
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-artifact
          path: FreeWaterTips.ReactNative/*.apk
          retention-days: 30
          if-no-files-found: warn

  build-ios:
    runs-on: macos-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      EXPO_PUBLIC_AZURE_FUNCTIONS_ENDPOINT: ${{ secrets.AZURE_FUNCTIONS_ENDPOINT }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: FreeWaterTips.ReactNative/package-lock.json
          
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
          
      - name: Install dependencies
        working-directory: FreeWaterTips.ReactNative
        run: npm ci
        
      - name: Build iOS IPA
        working-directory: FreeWaterTips.ReactNative
        run: eas build --platform ios --profile production --non-interactive --no-wait
        
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifact
          path: FreeWaterTips.ReactNative/*.ipa
          retention-days: 30
          if-no-files-found: warn

  deploy-azure-functions-to-azure:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-azure-functions]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download Azure Functions artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./publish
          
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTION_APP_NAME }}
          package: './publish'
  
  deploy-web-to-production:
    if: needs.detect-environment.outputs.environment == 'Production'
    runs-on: ubuntu-latest
    needs: [detect-environment, build-web, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download production artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-production-artifact
          path: ./web-output

      - name: Deploy to production via git commit
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone gh-pages branch
          git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ./gh-pages-temp
          cd ./gh-pages-temp
          
          # Clear root directory but keep .git
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +
          
          # Copy new production files from Expo web build
          cp -r ../web-output/* .
          
          # Add .nojekyll file to disable Jekyll processing (allows _expo directory)
          touch .nojekyll
          
          # Commit and push changes
          git add .
          git commit -m "Deploy production build from commit ${{ github.sha }}" || echo "No changes to commit"
          git push origin gh-pages

  deploy-web-to-testing:
    if: needs.detect-environment.outputs.environment == 'Testing'
    runs-on: ubuntu-latest
    needs: [detect-environment, build-web, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download testing artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-testing-artifact
          path: ./web-output

      - name: Deploy to testing repository via git commit
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone gh-pages branch of the test repository
          git clone --single-branch --branch gh-pages https://${GH_PAT}@github.com/ivan-zdravkov/free-water-tips-test.git ./gh-pages-test
          cd ./gh-pages-test
          
          # Clear root directory but keep .git
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +
          
          # Copy new testing files from Expo web build
          cp -r ../web-output/* .
          
          # Add .nojekyll file to disable Jekyll processing (allows _expo directory)
          touch .nojekyll
          
          # Add CNAME file for custom domain
          echo "test.freewater.tips" > CNAME
          
          # Commit and push changes
          git add .
          git commit -m "Deploy testing build from commit ${{ github.sha }}" || echo "No changes to commit"
          git push https://${GH_PAT}@github.com/ivan-zdravkov/free-water-tips-test.git gh-pages

  deploy-android-to-google-play:
    if: false # Temporarily disable Android deployments - enable for production builds when ready
    runs-on: ubuntu-latest
    needs: [detect-environment, build-android, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-artifact
          path: ./publish
          
      - name: Deploy to Google Play Store
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: tips.freewater.app
          releaseFiles: ./publish/*.apk
          track: ${{ secrets.GOOGLE_PLAY_TRACK }}

  deploy-ios-to-app-store:
    if: false # Temporarily disable iOS deployments - enable for production builds when ready
    runs-on: macos-latest
    needs: [detect-environment, build-ios, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-artifact
          path: ./publish
            
      - name: Deploy to App Store
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          xcrun altool --upload-app --type ios --file ./publish/*.ipa \
            --apiKey $APP_STORE_CONNECT_API_KEY_ID \
            --apiIssuer $APP_STORE_CONNECT_API_ISSUER_ID
