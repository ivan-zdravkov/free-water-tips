name: Deploy Full Stack Application

on:
  push:
    branches:
      - master
      - 'feature/*'
  pull_request:
    branches:
      - master

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
    
    steps:
      - name: Detect environment
        id: detect
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "environment=Production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/heads/feature/.* ]]; then
            echo "environment=Production" >> $GITHUB_OUTPUT
          else
            echo "environment=Production" >> $GITHUB_OUTPUT
          fi
          
          echo "Detected environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"
          echo "Branch: ${{ github.ref }}"

  build-azure-functions:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Restore dependencies
        run: dotnet restore AzureFunctions/AzureFunctions.csproj
        
      - name: Build Azure Functions
        run: dotnet build AzureFunctions/AzureFunctions.csproj --configuration Release --no-restore
        
      - name: Publish Azure Functions
        run: dotnet publish AzureFunctions/AzureFunctions.csproj --configuration Release --output ./publish/azure-functions --no-build
        
      - name: Upload Azure Functions artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./publish/azure-functions
          retention-days: 30

  build-web:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      BUILD_TARGET: web
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Install WebAssembly workloads
        run: dotnet workload install wasm-tools
          
      - name: Restore dependencies
        run: dotnet restore Clients/Clients.csproj
        
      - name: Build web application
        run: dotnet build Clients/Clients.csproj --configuration Release --no-restore --framework net10.0-browser
        
      - name: Publish web application
        run: dotnet publish Clients/Clients.csproj --configuration Release --output ./publish/web --framework net10.0-browser
        
      - name: Configure environment settings
        run: |
          if [[ "${{ needs.detect-environment.outputs.environment }}" == "Production" ]]; then
            echo "freewater.tips" > ./publish/web/wwwroot/CNAME
            sed -i 's|<base href="/free-water-tips/" />|<base href="/" />|g' ./publish/web/wwwroot/index.html
            sed -i 's|<base href="/free-water-tips/" />|<base href="/" />|g' ./publish/web/wwwroot/404.html
          else
            # Testing environment uses subdirectory on same domain
            sed -i 's|<base href="/free-water-tips/" />|<base href="/testing/" />|g' ./publish/web/wwwroot/index.html
            sed -i 's|<base href="/free-water-tips/" />|<base href="/testing/" />|g' ./publish/web/wwwroot/404.html
          fi
        
      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4
        
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./publish/web/wwwroot
          
      - name: Upload production artifact
        if: needs.detect-environment.outputs.environment == 'Production'
        uses: actions/upload-artifact@v4
        with:
          name: web-production-artifact
          path: ./publish/web/wwwroot
          retention-days: 1
          
      - name: Upload testing artifact
        if: needs.detect-environment.outputs.environment == 'Testing'
        uses: actions/upload-artifact@v4
        with:
          name: web-testing-artifact
          path: ./publish/web/wwwroot
          retention-days: 1

  build-android: 
    if: false # Temporarily disable Android builds at some point enable them only for production builds
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      BUILD_TARGET: android
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install MAUI Android workloads
        run: dotnet workload install maui-android
        
      - name: Restore dependencies
        run: dotnet restore Clients/Clients.csproj
        
      - name: Build Android application
        run: dotnet build Clients/Clients.csproj --configuration Release --no-restore --framework net10.0-android
        
      - name: Publish Android application
        run: dotnet publish Clients/Clients.csproj --configuration Release --output ./publish/android --framework net10.0-android
        
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-artifact
          path: ./publish/android
          retention-days: 30

  build-ios:
    if: false # Temporarily disable iOS builds at some point enable them only for production builds
    runs-on: macos-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      BUILD_TARGET: ios
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'
          
      - name: Install MAUI iOS workloads
        run: dotnet workload install maui-ios
        
      - name: Restore dependencies
        run: dotnet restore Clients/Clients.csproj
        
      - name: Build iOS application
        run: dotnet build Clients/Clients.csproj --configuration Release --no-restore --framework net10.0-ios -p:BuildIpa=false -p:CodesignKey="" -p:CodesignProvision=""
        
      - name: Publish iOS application
        run: dotnet publish Clients/Clients.csproj --configuration Release --output ./publish/ios --framework net10.0-ios -p:BuildIpa=false -p:CodesignKey="" -p:CodesignProvision=""
        
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifact
          path: ./publish/ios
          retention-days: 30

  deploy-azure-functions-to-azure:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-azure-functions]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download Azure Functions artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./publish
          
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTION_APP_NAME }}
          package: './publish'
  
  deploy-web-to-production:
    if: needs.detect-environment.outputs.environment == 'Production'
    runs-on: ubuntu-latest
    needs: [detect-environment, build-web, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download production artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-production-artifact
          path: ./web-output

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: ./gh-pages-checkout
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Preserve testing directory
        run: |
          if [ -d "./gh-pages-checkout/testing" ]; then
            cp -r ./gh-pages-checkout/testing ./testing-backup
            echo "Testing directory backed up"
          else
            echo "No testing directory found to preserve"
          fi
          
      - name: Deploy to production
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./web-output
          publish_branch: gh-pages
          keep_files: false
          force_orphan: false
          
      - name: Restore testing directory
        run: |
          if [ -d "./testing-backup" ]; then
            git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ./temp-gh-pages
            cp -r ./testing-backup ./temp-gh-pages/testing
            cd ./temp-gh-pages
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git add testing/
            git commit -m "Restore testing directory after production deployment" || echo "No changes to commit"
            git push origin gh-pages
            echo "Testing directory restored"
          fi

  deploy-web-to-testing:
    if: needs.detect-environment.outputs.environment == 'Testing'
    runs-on: ubuntu-latest
    needs: [detect-environment, build-web, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download testing artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-testing-artifact
          path: ./web-output

      - name: Clean testing directory
        run: |
          git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ./temp-gh-pages || git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ./temp-gh-pages --depth 1
          cd ./temp-gh-pages
          if [ -d "testing" ]; then
            rm -rf testing/*
            echo "Cleaned existing testing directory"
          else
            mkdir -p testing
            echo "Created new testing directory"
          fi
          
      - name: Deploy to testing environment
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./web-output
          publish_branch: gh-pages
          destination_dir: testing
          keep_files: true

  deploy-android-to-google-play:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-android, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-artifact
          path: ./publish
          
      - name: Sign Android APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: ./publish
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
          
      - name: Deploy to Google Play Store
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
          releaseFiles: ./publish/*.apk
          track: ${{ secrets.GOOGLE_PLAY_TRACK }}

  deploy-ios-to-app-store:
    runs-on: macos-latest
    needs: [detect-environment, build-ios, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-artifact
          path: ./publish
          
      - name: Install Apple certificates and provisioning profile
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain
          
          # Install certificate
          echo $IOS_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security import certificate.p12 -P $IOS_CERTIFICATE_PASSWORD -A -t cert -f pkcs12 -k build.keychain
          security list-keychain -d user -s build.keychain
          
          # Install provisioning profile
          echo $IOS_PROVISIONING_PROFILE_BASE64 | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
            
      - name: Deploy to App Store
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          xcrun altool --upload-app --type ios --file ./publish/*.ipa \
            --apiKey $APP_STORE_CONNECT_API_KEY_ID \
            --apiIssuer $APP_STORE_CONNECT_API_ISSUER_ID
