name: Deploy Full Stack Application

on:
  push:
    branches:
      - master
      - '*/*'
  pull_request:
    branches:
      - master

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
    
    steps:
      - name: Detect Environment
        id: detect
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "environment=Production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/heads/[^/]+/.* ]]; then
            echo "environment=Testing" >> $GITHUB_OUTPUT
          else
            echo "environment=Testing" >> $GITHUB_OUTPUT
          fi
          
          echo "Detected environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"
          echo "Branch: ${{ github.ref }}"

  build-azure-functions:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Restore dependencies
        run: dotnet restore AzureFunctions/AzureFunctions.csproj
        
      - name: Build Azure Functions
        run: dotnet build AzureFunctions/AzureFunctions.csproj --configuration Release --no-restore
        
      - name: Publish Azure Functions
        run: dotnet publish AzureFunctions/AzureFunctions.csproj --configuration Release --output ./publish/azure-functions --no-build
        
      - name: Upload Azure Functions artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./publish/azure-functions
          retention-days: 30

  build-web:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Install required workloads
        run: |
          dotnet workload install wasm-tools
          
      - name: Restore dependencies
        run: dotnet restore Clients/Clients.csproj
        
      - name: Build FreeWaterTips Web Application (Blazor WebAssembly)
        run: dotnet build Clients/Clients.csproj -f net10.0-browser --configuration Release --no-restore
        
      - name: Publish FreeWaterTips Web Application (Blazor WebAssembly)
        run: dotnet publish Clients/Clients.csproj -f net10.0-browser --configuration Release --output ./publish/web --no-build
        
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload FreeWaterTips Web artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./publish/web/wwwroot

  build-android:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install MAUI workload
        run: dotnet workload install maui
        
      - name: Restore dependencies
        run: dotnet restore Clients/Clients.csproj
        
      - name: Build FreeWaterTips Android Application
        run: dotnet build Clients/Clients.csproj -f net10.0-android --configuration Release --no-restore
        
      - name: Publish FreeWaterTips Android Application
        run: dotnet publish Clients/Clients.csproj -f net10.0-android --configuration Release --output ./publish/android --no-build
        
      - name: Upload FreeWaterTips Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: freewatertips-android-artifact
          path: ./publish/android
          retention-days: 30

  build-ios:
    runs-on: macos-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable
          
      - name: Install MAUI workload
        run: dotnet workload install maui
        
      - name: Restore dependencies
        run: dotnet restore Clients/Clients.csproj
        
      - name: Build FreeWaterTips iOS Application
        run: dotnet build Clients/Clients.csproj -f net10.0-ios --configuration Release --no-restore
        
      - name: Publish FreeWaterTips iOS Application
        run: dotnet publish Clients/Clients.csproj -f net10.0-ios --configuration Release --output ./publish/ios --no-build
        
      - name: Upload FreeWaterTips iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: freewatertips-ios-artifact
          path: ./publish/ios
          retention-days: 30

  deploy-azure-functions-to-azure:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-azure-functions, build-web, build-android, build-ios]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download Azure Functions artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./publish
          
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTION_APP_NAME }}
          package: './publish'
  
  deploy-web-to-github-pages:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-azure-functions, build-web, build-android, build-ios]
    environment: ${{ needs.detect-environment.outputs.environment }}
    steps:
      - name: Download FreeWaterTips web artifacts
        uses: actions/download-artifact@v4
        with:
          name: github-pages
          path: ./web-output

      - name: Deploy FreeWaterTips to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./web-output
          cname: ${{ secrets.WEB_DOMAIN }}
          destination_dir: ${{ vars.WEB_DESTINATION_DIR }}

  deploy-android-to-google-play:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-azure-functions, build-web, build-android, build-ios]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download FreeWaterTips Android artifact
        uses: actions/download-artifact@v4
        with:
          name: freewatertips-android-artifact
          path: ./publish
          
      - name: Sign FreeWaterTips Android APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: ./publish
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
          
      - name: Deploy FreeWaterTips to Google Play Store
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: ${{ vars.ANDROID_PACKAGE_NAME }}
          releaseFiles: ./publish/*.apk
          track: ${{ vars.GOOGLE_PLAY_TRACK }}

  deploy-ios-to-app-store:
    runs-on: macos-latest
    needs: [detect-environment, build-azure-functions, build-web, build-android, build-ios]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download FreeWaterTips iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: freewatertips-ios-artifact
          path: ./publish
          
      - name: Install Apple Certificate and Provisioning Profile
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain
          
          # Install certificate
          echo $IOS_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security import certificate.p12 -P $IOS_CERTIFICATE_PASSWORD -A -t cert -f pkcs12 -k build.keychain
          security list-keychain -d user -s build.keychain
          
          # Install provisioning profile
          echo $IOS_PROVISIONING_PROFILE_BASE64 | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
            
      - name: Deploy FreeWaterTips to App Store
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          xcrun altool --upload-app --type ios --file ./publish/*.ipa \
            --apiKey $APP_STORE_CONNECT_API_KEY_ID \
            --apiIssuer $APP_STORE_CONNECT_API_ISSUER_ID
