# Project Structure:
# - FreeWaterTips.API.Azure.Functions/ - Azure Functions backend (.NET)
# - FreeWaterTips.ReactNative/ - React Native with Expo (Web, Android & iOS)

# ====================================================================================================
# ENVIRONMENT SECRETS AND VARIABLES DOCUMENTATION
# ====================================================================================================
#
# The following secrets and variables must be configured in GitHub repository settings:
# Settings -> Secrets and variables -> Actions
#
# --- AZURE BACKEND SECRETS (✓ Implemented) ---
#
# ✓ COSMOS_DB_ENDPOINT
#   Description: Azure Cosmos DB endpoint URL for the database connection
#   How to obtain: Azure Portal -> Cosmos DB account -> Keys -> URI
#   Example: https://your-cosmosdb-account.documents.azure.com:443/
#
# ✓ COSMOS_DB_KEY
#   Description: Primary or secondary key for authenticating with Azure Cosmos DB
#   How to obtain: Azure Portal -> Cosmos DB account -> Keys -> Primary Key or Secondary Key
#   Security: Keep this secret secure; rotate periodically
#
# ✓ AZURE_CREDENTIALS
#   Description: JSON credentials for Azure service principal authentication
#   How to obtain: Run `az ad sp create-for-rbac --name "github-actions" --role contributor --scopes /subscriptions/{subscription-id}/resourceGroups/{resource-group} --sdk-auth`
#   Format: JSON object with clientId, clientSecret, subscriptionId, tenantId
#   Docs: https://github.com/Azure/login#configure-a-service-principal-with-a-secret
#
# ✓ AZURE_FUNCTION_APP_NAME
#   Description: Name of the Azure Function App to deploy to
#   How to obtain: Azure Portal -> Function App -> Overview -> Name
#   Example: free-water-tips-api
#
# ✓ AZURE_FUNCTIONS_ENDPOINT
#   Description: Public endpoint URL of the deployed Azure Functions API
#   How to obtain: Azure Portal -> Function App -> Overview -> URL
#   Example: https://free-water-tips-api.azurewebsites.net
#   Usage: Used as EXPO_PUBLIC_AZURE_FUNCTIONS_ENDPOINT in React Native builds
#
# ✓ AZURE_RESOURCE_GROUP_NAME
#   Description: Name of the Azure Resource Group containing the Function App
#   How to obtain: Azure Portal -> Resource groups -> Your resource group -> Overview -> Resource group name
#   Example: rg-free-water-tips
#   Usage: Required for configuring Function App settings via Azure CLI
#
# ✓ AZURE_STORAGE_CONNECTION_STRING
#   Description: Connection string for Azure Storage Account used by Azure Functions
#   How to obtain: Azure Portal -> Storage accounts -> Your storage account -> Security + networking -> Access keys -> Connection string
#   Example: DefaultEndpointsProtocol=https;AccountName=...;AccountKey=...;EndpointSuffix=core.windows.net
#   Security: Keep this secret secure; required for Azure Functions runtime (AzureWebJobsStorage)
#
# --- WEB DEPLOYMENT SECRETS (✓ Implemented) ---
#
# ✓ GITHUB_TOKEN
#   Description: Automatically provided by GitHub Actions for repository access
#   How to obtain: Automatically available in workflows (no configuration needed)
#   Usage: Used for deploying to gh-pages branch
#
# ✓ REPOSITORY_PAT
#   Description: Personal Access Token for deploying to external testing repository
#   How to obtain: GitHub Settings -> Developer settings -> Personal access tokens -> Generate new token
#   Required scopes: repo (full control of private repositories)
#   Usage: Deploy to ivan-zdravkov/free-water-tips-test repository
#
# --- ANDROID BUILD & DEPLOYMENT SECRETS (✗ TODO - Not yet implemented) ---
#
# ✗ ANDROID_KEYSTORE_BASE64
#   Description: Base64-encoded Android keystore file for signing APK/AAB files
#   How to obtain: Generate keystore with `keytool -genkey -v -keystore release.keystore -alias release -keyalg RSA -keysize 2048 -validity 10000`
#                  Then encode: `base64 -i release.keystore | tr -d '\n'`
#   Docs: https://developer.android.com/studio/publish/app-signing
#
# ✗ ANDROID_KEYSTORE_PASSWORD
#   Description: Password for the Android keystore file
#   How to obtain: Use the password you set when generating the keystore
#
# ✗ ANDROID_KEY_ALIAS
#   Description: Alias name for the signing key in the keystore
#   How to obtain: Use the alias you set when generating the keystore (e.g., "release")
#
# ✗ ANDROID_KEY_PASSWORD
#   Description: Password for the specific key in the keystore
#   How to obtain: Use the key password you set when generating the keystore
#
# ✗ GOOGLE_PLAY_SERVICE_ACCOUNT
#   Description: JSON key file for Google Play Console service account
#   How to obtain: Google Play Console -> Setup -> API access -> Create service account -> Create and download JSON key
#   Docs: https://developers.google.com/android-publisher/getting_started
#
# ✗ GOOGLE_PLAY_TRACK
#   Description: Release track for Google Play deployment (internal, alpha, beta, production)
#   How to obtain: Choose the appropriate track based on deployment strategy
#   Example: "internal" for testing, "production" for live releases
#
# --- iOS BUILD & DEPLOYMENT SECRETS (✗ TODO - Not yet implemented) ---
#
# ✗ IOS_CERTIFICATE_BASE64
#   Description: Base64-encoded Apple distribution certificate (.p12 file)
#   How to obtain: Apple Developer -> Certificates -> Create distribution certificate -> Export as .p12
#                  Then encode: `base64 -i certificate.p12 | tr -d '\n'`
#   Docs: https://developer.apple.com/documentation/xcode/distributing-your-app-for-beta-testing-and-releases
#
# ✗ IOS_CERTIFICATE_PASSWORD
#   Description: Password for the .p12 certificate file
#   How to obtain: Use the password you set when exporting the certificate
#
# ✗ IOS_PROVISIONING_PROFILE_BASE64
#   Description: Base64-encoded Apple provisioning profile (.mobileprovision file)
#   How to obtain: Apple Developer -> Profiles -> Create App Store distribution profile -> Download
#                  Then encode: `base64 -i profile.mobileprovision | tr -d '\n'`
#
# ✗ IOS_KEYCHAIN_PASSWORD
#   Description: Temporary password for the GitHub Actions keychain (can be any secure random string)
#   How to obtain: Generate a random password (e.g., using password generator)
#   Security: Used only during build process, doesn't need to match any existing password
#
# ✗ APPLE_TEAM_ID
#   Description: Apple Developer Team ID for code signing
#   How to obtain: Apple Developer -> Membership -> Team ID
#   Example: "A1B2C3D4E5"
#
# ✗ APPLE_APP_STORE_API_KEY_ID
#   Description: Key ID for App Store Connect API authentication
#   How to obtain: App Store Connect -> Users and Access -> Keys -> Generate API Key
#   Docs: https://developer.apple.com/documentation/appstoreconnectapi/creating_api_keys_for_app_store_connect_api
#
# ✗ APPLE_APP_STORE_API_ISSUER_ID
#   Description: Issuer ID for App Store Connect API authentication
#   How to obtain: App Store Connect -> Users and Access -> Keys -> Copy Issuer ID (at the top)
#
# ✗ APPLE_APP_STORE_API_KEY_BASE64
#   Description: Base64-encoded App Store Connect API key (.p8 file)
#   How to obtain: Download .p8 file when creating API key, then encode: `base64 -i AuthKey_XXX.p8 | tr -d '\n'`
#
# ====================================================================================================

name: Deploy Full Stack Application

on:
  push:
    branches:
      - master
      - 'feature/*'
  pull_request:
    branches:
      - master

permissions:
  contents: write
  id-token: write

concurrency:
  group: 'deploy-${{ github.ref }}'
  cancel-in-progress: false

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
      should_deploy: ${{ steps.detect.outputs.should_deploy }}

    steps:
      - name: Detect environment
        id: detect
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "environment=Production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/heads/feature/.* ]]; then
            echo "environment=Testing" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=Testing" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

          echo "Detected environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"
          echo "Should deploy: $(cat $GITHUB_OUTPUT | grep should_deploy | cut -d= -f2)"
          echo "Branch: ${{ github.ref }}"

  build-azure-functions:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'

      - name: Cache .NET packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: azure-functions-${{ runner.os }}-nuget-${{ hashFiles('**/FreeWaterTips.API.Azure.Functions.csproj', '**/FreeWaterTips.DB.Cosmos.csproj', '**/FreeWaterTips.Utils.csproj') }}
          restore-keys: |
            azure-functions-${{ runner.os }}-nuget-

      - name: Restore dependencies
        run: dotnet restore FreeWaterTips.API.Azure.Functions/FreeWaterTips.API.Azure.Functions.csproj

      - name: Build Azure Functions
        run: dotnet build FreeWaterTips.API.Azure.Functions/FreeWaterTips.API.Azure.Functions.csproj --configuration Release --no-restore

      - name: Publish Azure Functions
        run: |
          dotnet publish FreeWaterTips.API.Azure.Functions/FreeWaterTips.API.Azure.Functions.csproj \
            --configuration Release \
            --output ./artifacts/azure-functions \
            --no-build \
            --verbosity normal

          # Verify the functions.metadata file exists
          echo "Checking for functions.metadata..."
          ls -la ./artifacts/azure-functions/functions.metadata || echo "functions.metadata not found!"

          # Show what was published
          echo "Published files:"
          ls -la ./artifacts/azure-functions/

      - name: Upload Azure Functions artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./artifacts/azure-functions
          retention-days: 3

  build-web:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      EXPO_PUBLIC_AZURE_FUNCTIONS_ENDPOINT: ${{ secrets.AZURE_FUNCTIONS_ENDPOINT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: FreeWaterTips.ReactNative/package-lock.json

      - name: Install dependencies
        working-directory: FreeWaterTips.ReactNative
        run: npm ci

      - name: Build web application
        working-directory: FreeWaterTips.ReactNative
        run: npx expo export --platform web --output-dir ./artifacts/web

      - name: Upload web artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-artifact
          path: FreeWaterTips.ReactNative/artifacts/web
          retention-days: 3

  build-android:
    if: false # Temporarily disable Android builds - enable for production builds when ready to use
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      EXPO_PUBLIC_AZURE_FUNCTIONS_ENDPOINT: ${{ secrets.AZURE_FUNCTIONS_ENDPOINT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: FreeWaterTips.ReactNative/package-lock.json

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Install dependencies
        working-directory: FreeWaterTips.ReactNative
        run: npm ci

      - name: Decode and setup Android keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > FreeWaterTips.ReactNative/android/app/release.keystore

      - name: Run Expo prebuild for Android
        working-directory: FreeWaterTips.ReactNative
        run: npx expo prebuild --platform android --clean

      - name: Build signed Android App Bundle (AAB)
        working-directory: FreeWaterTips.ReactNative/android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          ./gradlew bundleRelease \
            -Pandroid.injected.signing.store.file=$PWD/app/release.keystore \
            -Pandroid.injected.signing.store.password=$KEYSTORE_PASSWORD \
            -Pandroid.injected.signing.key.alias=$KEY_ALIAS \
            -Pandroid.injected.signing.key.password=$KEY_PASSWORD

      - name: Copy Android artifact to artifacts directory
        run: |
          mkdir -p ./artifacts/android
          cp FreeWaterTips.ReactNative/android/app/build/outputs/bundle/release/*.aab ./artifacts/android/

      - name: Upload signed Android AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-artifact
          path: ./artifacts/android
          retention-days: 3

  build-ios:
    if: false # Temporarily disable iOS builds - enable for production builds when ready to use
    runs-on: macos-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      EXPO_PUBLIC_AZURE_FUNCTIONS_ENDPOINT: ${{ secrets.AZURE_FUNCTIONS_ENDPOINT }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: FreeWaterTips.ReactNative/package-lock.json

      - name: Install dependencies
        working-directory: FreeWaterTips.ReactNative
        run: npm ci

      - name: Install CocoaPods
        run: sudo gem install cocoapods

      - name: Setup Apple certificates and provisioning profiles
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          IOS_KEYCHAIN_PASSWORD: ${{ secrets.IOS_KEYCHAIN_PASSWORD }}
        run: |
          # Create variables
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Decode certificate and provisioning profile
          echo -n "$IOS_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$IOS_PROVISIONING_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # Create temporary keychain
          security create-keychain -p "$IOS_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-default $KEYCHAIN_PATH
          security unlock-keychain -p "$IOS_KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Import certificate to keychain
          security import $CERTIFICATE_PATH -P "$IOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

      - name: Run Expo prebuild for iOS
        working-directory: FreeWaterTips.ReactNative
        run: npx expo prebuild --platform ios --clean

      - name: Install iOS dependencies
        working-directory: FreeWaterTips.ReactNative/ios
        run: pod install

      - name: Build and archive iOS app
        working-directory: FreeWaterTips.ReactNative/ios
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -n 1 | sed 's|^\./||')
          SCHEME=$(basename "$WORKSPACE" .xcworkspace)

          xcodebuild -workspace "$WORKSPACE" \
            -scheme "$SCHEME" \
            -configuration Release \
            -sdk iphoneos \
            -archivePath $PWD/build/FreeWaterTips.xcarchive \
            -allowProvisioningUpdates \
            DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
            archive

      - name: Export signed IPA
        working-directory: FreeWaterTips.ReactNative/ios
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          # Replace team ID placeholder in exportOptions.plist
          sed "s/\$(APPLE_TEAM_ID)/$APPLE_TEAM_ID/g" ../exportOptions.plist > exportOptions-final.plist

          xcodebuild -exportArchive \
            -archivePath $PWD/build/FreeWaterTips.xcarchive \
            -exportPath $PWD/build \
            -exportOptionsPlist exportOptions-final.plist

      - name: Copy iOS artifact to artifacts directory
        working-directory: FreeWaterTips.ReactNative
        run: |
          mkdir -p ./artifacts/ios
          cp ios/build/*.ipa ./artifacts/ios/

      - name: Upload signed iOS IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifact
          path: FreeWaterTips.ReactNative/artifacts/ios
          retention-days: 3

  deploy-azure-functions:
    if: needs.detect-environment.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    needs: [detect-environment, build-azure-functions]
    environment: ${{ needs.detect-environment.outputs.environment }}

    steps:
      - name: Download Azure Functions artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./artifacts/azure-functions

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Configure Azure Function App Settings
        run: |
          az functionapp config appsettings set \
            --name ${{ secrets.AZURE_FUNCTION_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} \
            --settings \
              AzureWebJobsStorage="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              FUNCTIONS_WORKER_RUNTIME="dotnet-isolated" \
              FUNCTIONS_EXTENSION_VERSION="~4" \
              WEBSITE_RUN_FROM_PACKAGE="1" \
              WEBSITE_CONTENTAZUREFILECONNECTIONSTRING="${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}" \
              WEBSITE_CONTENTSHARE="fwt-${{ needs.detect-environment.outputs.environment == 'Production' && 'prod' || 'test' }}" \
              COSMOS_DB_ENDPOINT="${{ secrets.COSMOS_DB_ENDPOINT }}" \
              COSMOS_DB_KEY="${{ secrets.COSMOS_DB_KEY }}"

      - name: Restart Azure Function App
        run: |
          echo "Restarting Function App to ensure new settings are loaded..."
          az functionapp restart \
            --name ${{ secrets.AZURE_FUNCTION_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP_NAME }}
          echo "Function App restarted successfully"

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTION_APP_NAME }}
          package: './artifacts/azure-functions'

      - name: Verify function deployment
        run: |
          echo "Waiting for deployment to complete..."
          sleep 60

          echo "Checking if functions are now loaded..."
          az functionapp function list \
            --name ${{ secrets.AZURE_FUNCTION_APP_NAME }} \
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP_NAME }} || echo "No functions found yet"

  deploy-web:
    if: needs.detect-environment.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    needs: [detect-environment, build-web, deploy-azure-functions]
    environment: ${{ needs.detect-environment.outputs.environment }}

    steps:
      - name: Checkout code
        if: needs.detect-environment.outputs.environment == 'Production'
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download web artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-artifact
          path: ./artifacts/web

      - name: Deploy to production
        if: needs.detect-environment.outputs.environment == 'Production'
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone gh-pages branch
          git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ./gh-pages-temp
          cd ./gh-pages-temp

          # Clear root directory but keep .git
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +

          # Copy new production files from Expo web build
          cp -r ../artifacts/web/* .

          # Add .nojekyll file to disable Jekyll processing (allows _expo directory)
          touch .nojekyll

          # Add CNAME file for custom domain
          echo "freewater.tips" > CNAME

          # Commit and push changes
          git add .
          git commit -m "Deploy production build from commit ${{ github.sha }}" || echo "No changes to commit"
          git push origin gh-pages

      - name: Deploy to testing
        if: needs.detect-environment.outputs.environment == 'Testing'
        env:
          REPOSITORY_PAT: ${{ secrets.REPOSITORY_PAT }}
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Clone gh-pages branch of the test repository
          git clone --single-branch --branch gh-pages https://${REPOSITORY_PAT}@github.com/ivan-zdravkov/free-water-tips-test.git ./gh-pages-test
          cd ./gh-pages-test

          # Clear root directory but keep .git
          find . -maxdepth 1 ! -name '.git' ! -name '.' ! -name '..' -exec rm -rf {} +

          # Copy new testing files from Expo web build
          cp -r ../artifacts/web/* .

          # Add .nojekyll file to disable Jekyll processing (allows _expo directory)
          touch .nojekyll

          # Add CNAME file for custom domain
          echo "test.freewater.tips" > CNAME

          # Commit and push changes
          git add .
          git commit -m "Deploy testing build from commit ${{ github.sha }}" || echo "No changes to commit"
          git push https://${REPOSITORY_PAT}@github.com/ivan-zdravkov/free-water-tips-test.git gh-pages

  deploy-android:
    # Temporarily disable Android builds / deployments - enable for production builds when ready to use
    # When enabled, also check: needs.detect-environment.outputs.should_deploy == 'true'
    if: false
    runs-on: ubuntu-latest
    needs: [detect-environment, build-android]
    environment: ${{ needs.detect-environment.outputs.environment }}

    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-artifact
          path: ./artifacts/android

      - name: Upload to Google Play Store
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: tips.freewater.app
          releaseFiles: ./artifacts/android/*.aab
          track: ${{ secrets.GOOGLE_PLAY_TRACK }}

  deploy-ios:
    # Temporarily disable iOS builds / deployments - enable for production builds when ready to use
    # When enabled, also check: needs.detect-environment.outputs.should_deploy == 'true'
    if: false
    runs-on: macos-latest
    needs: [detect-environment, build-ios]
    environment: ${{ needs.detect-environment.outputs.environment }}

    steps:
      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-artifact
          path: ./artifacts/ios

      - name: Upload to App Store Connect
        env:
          APPLE_APP_STORE_API_KEY_ID: ${{ secrets.APPLE_APP_STORE_API_KEY_ID }}
          APPLE_APP_STORE_API_ISSUER_ID: ${{ secrets.APPLE_APP_STORE_API_ISSUER_ID }}
          APPLE_APP_STORE_API_KEY_BASE64: ${{ secrets.APPLE_APP_STORE_API_KEY_BASE64 }}
        run: |
          # Decode and save API key to file
          echo -n "$APPLE_APP_STORE_API_KEY_BASE64" | base64 --decode > AuthKey.p8

          # Upload IPA to App Store Connect
          xcrun altool --upload-app \
            --type ios \
            --file ./artifacts/ios/*.ipa \
            --apiKey "$APPLE_APP_STORE_API_KEY_ID" \
            --apiIssuer "$APPLE_APP_STORE_API_ISSUER_ID"
