name: Deploy Full Stack Application

# Project Structure:
# - AzureFunctions/ - Azure Functions backend
# - FreeWaterTips/FreeWaterTips/ - MAUI hybrid app (Android & iOS)
# - FreeWaterTips/FreeWaterTips.Web/ - Blazor Server web app
# - FreeWaterTips/FreeWaterTips.Web.Client/ - Blazor WebAssembly client
# - FreeWaterTips/FreeWaterTips.Shared/ - Shared components library

on:
  push:
    branches:
      - master
      - 'feature/*'
  pull_request:
    branches:
      - master

permissions:
  contents: write
  id-token: write

concurrency:
  group: "deploy-${{ github.ref }}"
  cancel-in-progress: false

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.detect.outputs.environment }}
    
    steps:
      - name: Detect environment
        id: detect
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
            echo "environment=Production" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" =~ ^refs/heads/feature/.* ]]; then
            echo "environment=Testing" >> $GITHUB_OUTPUT
          else
            echo "environment=Testing" >> $GITHUB_OUTPUT
          fi
          
          echo "Detected environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d= -f2)"
          echo "Branch: ${{ github.ref }}"

  build-azure-functions:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Cache .NET packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: azure-functions-${{ runner.os }}-nuget-${{ hashFiles('**/AzureFunctions.csproj', '**/DB.Cosmos.csproj', '**/Utils.csproj') }}
          restore-keys: |
            azure-functions-${{ runner.os }}-nuget-
          
      - name: Restore dependencies
        run: dotnet restore AzureFunctions/AzureFunctions.csproj
        
      - name: Build Azure Functions
        run: dotnet build AzureFunctions/AzureFunctions.csproj --configuration Release --no-restore
        
      - name: Publish Azure Functions
        run: dotnet publish AzureFunctions/AzureFunctions.csproj --configuration Release --output ./publish/azure-functions --no-build
        
      - name: Upload Azure Functions artifact
        uses: actions/upload-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./publish/azure-functions
          retention-days: 30

  build-web:
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      BUILD_TARGET: web
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Cache .NET packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: web-${{ runner.os }}-nuget-${{ hashFiles('**/FreeWaterTips.Web*.csproj', '**/FreeWaterTips.Shared.csproj') }}
          restore-keys: |
            web-${{ runner.os }}-nuget-
          
      - name: Install WebAssembly workloads
        run: |
          dotnet --info
          dotnet workload install wasm-tools --skip-sign-check
          dotnet workload install microsoft-net-sdk-blazorwebassembly-aot --skip-sign-check || echo "AOT workload not available"
          
      - name: Restore dependencies
        run: dotnet restore FreeWaterTips/FreeWaterTips.Web/FreeWaterTips.Web.csproj --verbosity normal
        
      - name: Build web application
        run: dotnet build FreeWaterTips/FreeWaterTips.Web/FreeWaterTips.Web.csproj --configuration Release --no-restore --verbosity normal
        
      - name: Publish web application
        run: |
          dotnet publish FreeWaterTips/FreeWaterTips.Web/FreeWaterTips.Web.csproj --configuration Release --output ./publish/web --verbosity normal --no-restore --self-contained false
        
      - name: Configure environment settings
        run: |
          # Find the actual wwwroot directory in the published output
          WWWROOT_PATH=$(find ./publish/web -name "wwwroot" -type d | head -1)
          if [ -z "$WWWROOT_PATH" ]; then
            echo "Error: Could not find wwwroot directory"
            find ./publish/web -type d -name "*www*" || echo "No www directories found"
            exit 1
          fi
          
          if [[ "${{ needs.detect-environment.outputs.environment }}" == "Production" ]]; then
            echo "freewater.tips" > "$WWWROOT_PATH/CNAME"
            # Update base href for production if needed
            find "$WWWROOT_PATH" -name "*.html" -exec sed -i 's|<base href="/free-water-tips/" />|<base href="/" />|g' {} \;
          else
            # Testing environment uses subdirectory on same domain
            find "$WWWROOT_PATH" -name "*.html" -exec sed -i 's|<base href="/free-water-tips/" />|<base href="/testing/" />|g' {} \;
            # Update title for testing environment
            find "$WWWROOT_PATH" -name "*.html" -exec sed -i 's|<title>Free Water Tips</title>|<title>Testing Free Water Tips</title>|g' {} \;
          fi
        

          
      - name: Upload production artifact
        if: needs.detect-environment.outputs.environment == 'Production'
        uses: actions/upload-artifact@v4
        with:
          name: web-production-artifact
          path: ./publish/web
          retention-days: 1
          
      - name: Upload testing artifact
        if: needs.detect-environment.outputs.environment == 'Testing'
        uses: actions/upload-artifact@v4
        with:
          name: web-testing-artifact
          path: ./publish/web
          retention-days: 1

  build-android: 
    runs-on: ubuntu-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      BUILD_TARGET: android
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Install MAUI Android workloads
        run: dotnet workload install maui-android
        
      - name: Restore dependencies
        run: dotnet restore FreeWaterTips/FreeWaterTips/FreeWaterTips.csproj
        
      - name: Build Android application
        run: dotnet build FreeWaterTips/FreeWaterTips/FreeWaterTips.csproj --configuration Release --no-restore --framework net10.0-android
        
      - name: Publish Android application
        run: dotnet publish FreeWaterTips/FreeWaterTips/FreeWaterTips.csproj --configuration Release --output ./publish/android --framework net10.0-android
        
      - name: Upload Android artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-artifact
          path: ./publish/android
          retention-days: 30

  build-ios:
    runs-on: macos-latest
    needs: detect-environment
    environment: ${{ needs.detect-environment.outputs.environment }}
    env:
      ENVIRONMENT: ${{ needs.detect-environment.outputs.environment }}
      BUILD_TARGET: ios
      COSMOS_DB_ENDPOINT: ${{ secrets.COSMOS_DB_ENDPOINT }}
      COSMOS_DB_KEY: ${{ secrets.COSMOS_DB_KEY }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
          
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'
          
      - name: Install MAUI iOS workloads
        run: dotnet workload install maui-ios
        
      - name: Restore dependencies
        run: dotnet restore FreeWaterTips/FreeWaterTips/FreeWaterTips.csproj
        
      - name: Build iOS application
        run: dotnet build FreeWaterTips/FreeWaterTips/FreeWaterTips.csproj --configuration Release --no-restore --framework net10.0-ios -p:BuildIpa=false -p:CodesignKey="" -p:CodesignProvision=""
        
      - name: Publish iOS application
        run: dotnet publish FreeWaterTips/FreeWaterTips/FreeWaterTips.csproj --configuration Release --output ./publish/ios --framework net10.0-ios -p:BuildIpa=false -p:CodesignKey="" -p:CodesignProvision=""
        
      - name: Upload iOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifact
          path: ./publish/ios
          retention-days: 30

  deploy-azure-functions-to-azure:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-azure-functions]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download Azure Functions artifact
        uses: actions/download-artifact@v4
        with:
          name: azure-functions-artifact
          path: ./publish
          
      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
          
      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_FUNCTION_APP_NAME }}
          package: './publish'
  
  deploy-web-to-production:
    if: needs.detect-environment.outputs.environment == 'Production'
    runs-on: ubuntu-latest
    needs: [detect-environment, build-web, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download production artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-production-artifact
          path: ./web-output

      - name: Deploy to production via git commit
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone gh-pages branch
          git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ./gh-pages-temp
          cd ./gh-pages-temp
          
          # Backup testing directory if it exists
          if [ -d "testing" ]; then
            cp -r testing ../testing-backup
          fi
          
          # Clear root directory but keep .git and testing
          find . -maxdepth 1 ! -name '.git' ! -name 'testing' -exec rm -rf {} +
          
          # Copy new production files (find wwwroot and copy its contents)
          WWWROOT_PATH=$(find ../web-output -name "wwwroot" -type d | head -1)
          if [ -n "$WWWROOT_PATH" ]; then
            cp -r "$WWWROOT_PATH"/* .
          else
            # Fallback: copy all web-output contents
            cp -r ../web-output/* .
          fi
          
          # Restore testing directory
          if [ -d "../testing-backup" ]; then
            cp -r ../testing-backup testing
          fi
          
          # Commit and push changes
          git add .
          git commit -m "Deploy production build from commit ${{ github.sha }}" || echo "No changes to commit"
          git push origin gh-pages

  deploy-web-to-testing:
    if: needs.detect-environment.outputs.environment == 'Testing'
    runs-on: ubuntu-latest
    needs: [detect-environment, build-web, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Download testing artifacts
        uses: actions/download-artifact@v4
        with:
          name: web-testing-artifact
          path: ./web-output

      - name: Deploy to testing environment via git commit
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone gh-pages branch
          git clone --single-branch --branch gh-pages https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git ./gh-pages-temp
          cd ./gh-pages-temp
          
          # Create/update testing directory
          rm -rf testing
          mkdir -p testing
          
          # Copy new testing files (find wwwroot and copy its contents)
          WWWROOT_PATH=$(find ../web-output -name "wwwroot" -type d | head -1)
          if [ -n "$WWWROOT_PATH" ]; then
            cp -r "$WWWROOT_PATH"/* testing/
          else
            # Fallback: copy all web-output contents
            cp -r ../web-output/* testing/
          fi
          
          # Commit and push changes
          git add testing/
          git commit -m "Deploy testing build from commit ${{ github.sha }}" || echo "No changes to commit"
          git push origin gh-pages

  deploy-android-to-google-play:
    if: false # Temporarily disable Android deployments and at some point enable them only for production builds
    runs-on: ubuntu-latest
    needs: [detect-environment, build-android, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-artifact
          path: ./publish
          
      - name: Sign Android APK
        uses: r0adkll/sign-android-release@v1
        with:
          releaseDirectory: ./publish
          signingKeyBase64: ${{ secrets.ANDROID_SIGNING_KEY }}
          alias: ${{ secrets.ANDROID_KEY_ALIAS }}
          keyStorePassword: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyPassword: ${{ secrets.ANDROID_KEY_PASSWORD }}
          
      - name: Deploy to Google Play Store
        uses: r0adkll/upload-google-play@v1.1.3
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: ${{ secrets.ANDROID_PACKAGE_NAME }}
          releaseFiles: ./publish/*.apk
          track: ${{ secrets.GOOGLE_PLAY_TRACK }}

  deploy-ios-to-app-store:
    if: false # Temporarily disable iOS deployments and at some point enable them only for production builds
    runs-on: macos-latest
    needs: [detect-environment, build-ios, deploy-azure-functions-to-azure]
    environment: ${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-artifact
          path: ./publish
          
      - name: Install Apple certificates and provisioning profile
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "" build.keychain
          security set-keychain-settings -lut 21600 build.keychain
          security unlock-keychain -p "" build.keychain
          
          # Install certificate
          echo $IOS_CERTIFICATE_BASE64 | base64 --decode > certificate.p12
          security import certificate.p12 -P $IOS_CERTIFICATE_PASSWORD -A -t cert -f pkcs12 -k build.keychain
          security list-keychain -d user -s build.keychain
          
          # Install provisioning profile
          echo $IOS_PROVISIONING_PROFILE_BASE64 | base64 --decode > profile.mobileprovision
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp profile.mobileprovision ~/Library/MobileDevice/Provisioning\ Profiles/
            
      - name: Deploy to App Store
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_API_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          xcrun altool --upload-app --type ios --file ./publish/*.ipa \
            --apiKey $APP_STORE_CONNECT_API_KEY_ID \
            --apiIssuer $APP_STORE_CONNECT_API_ISSUER_ID
