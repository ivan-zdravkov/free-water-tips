const {
    createClient,
    getContainer,
    handleDatabaseError,
    getContainerKeyFromArgs
} = require('../utils/cosmos');

async function cleanDatabase(containerKey) {
    console.log(`üßπ Cleaning ${containerKey} container...`);
    
    try {
        const client = createClient();
        const container = await getContainer(client, containerKey);

        console.log(`üìã Querying all documents in ${container.id} container...`);

        const { resources: items } = await container.items
            .query({ query: 'SELECT * FROM c' })
            .fetchAll();

        console.log(`Found ${items.length} items to delete`);

        if (items.length === 0) {
            console.log(`‚úÖ ${container.id} container is already clean!`);
            return;
        }

        let deleted = 0;
        let errors = 0;
        
        for (const item of items) {
            try {
                const partitionKeyValue = item.partitionKey || item.id;
                await container.item(item.id, partitionKeyValue).delete();
                deleted++;
                console.log(`üóëÔ∏è  Deleted: ${item.name || item.id} (${deleted}/${items.length})`);
            } catch (deleteError) {
                errors++;
                console.error(`‚ùå Failed to delete ${item.name || item.id}: ${deleteError.message}`);
            }
        }

        console.log(`\nüéØ Cleaning completed!`);
        console.log(`   ‚úÖ Successfully deleted: ${deleted}/${items.length} items`);
        if (errors > 0) {
            console.log(`   ‚ùå Errors encountered: ${errors}/${items.length} items`);
        }
    } catch (error) {
        handleDatabaseError(error);
    }
}

if (require.main === module) {
    const containerKey = getContainerKeyFromArgs();

    cleanDatabase(containerKey);
}

module.exports = { cleanDatabase };
